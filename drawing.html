<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Draw</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="dark">
<div class="dot-bg"></div>
<div class="form-wrapper">
  <div class="form-card" style="max-width: 800px; overflow:hidden;">
    <div class="header typewriter"><h2>Creative Canvas</h2></div>
    
    <div class="toolbar">
      <button class="icon-btn active" id="brushBtn" title="Brush">‚úèÔ∏è</button>
      <button class="icon-btn" id="fillBtn" title="Fill Bucket">ü™£</button>
      <button class="icon-btn" id="rectBtn" title="Rectangle">‚¨ú</button>
      <button class="icon-btn" id="circleBtn" title="Circle">‚≠ï</button>
      <button class="icon-btn" id="textBtn" title="Text Tool">T</button>
      <button class="icon-btn" id="stickerBtn" title="Stickers (Click to set)">üòÄ</button>
      <button class="icon-btn" id="eraserBtn" title="Eraser">üßπ</button>
      <button class="icon-btn" id="undoBtn" title="Undo">‚Ü©Ô∏è</button>
      <button class="icon-btn" id="bgBtn" title="Backgrounds">üñºÔ∏è</button>
      <button class="icon-btn" id="clearBtn" style="background:#ff4444;" title="Clear All">üóëÔ∏è</button>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
        <input type="color" id="colorPicker" value="#ffffff" style="width:40px; height:40px; border:none; padding:0;">
        <input type="range" id="sizeSlider" min="2" max="50" value="5" style="flex-grow:1;">
        <span id="sizeLabel" style="font-size:12px; width:30px;">5px</span>
    </div>

    <canvas id="drawingCanvas" style="background:#000; border:1px solid #444; width:100%; height:400px; border-radius:12px; touch-action:none; cursor:crosshair;"></canvas>
    
    <div class="btn-row" id="saveSection">
      <button id="submitBtn" type="button" class="primary-btn">üíæ Save & Submit</button>

    </div>
  </div>
</div>

<script type="module">
  import { db, doc, updateDoc } from "./config.js";
  import { generateCertificate } from "./certificate.js";
  const { jsPDF } = window.jspdf;

  const canvas = document.getElementById('drawingCanvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  
  // HISTORY FOR UNDO
  let history = [];
  let historyStep = -1;

  function saveHistory() {
      historyStep++;
      if (historyStep < history.length) { history.length = historyStep; }
      history.push(canvas.toDataURL());
      if(history.length > 10) { history.shift(); historyStep--; }
  }

  function undo() {
      if (historyStep > 0) {
          historyStep--;
          const img = new Image();
          img.src = history[historyStep];
          img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); };
      }
  }

  // RESIZE & INIT
  function resize() { 
      if(canvas.width !== canvas.offsetWidth) {
        const s = canvas.toDataURL(); 
        canvas.width = canvas.offsetWidth; 
        canvas.height = 400; 
        const i = new Image(); i.src = s; 
        i.onload = () => {
            if(s.length < 1000) { ctx.fillStyle = "#000000"; ctx.fillRect(0,0,canvas.width,canvas.height); }
            else ctx.drawImage(i,0,0);
            saveHistory();
        };
      }
  }
  setTimeout(resize, 100);

  // STATE VARIABLES
  let isDrawing = false, mode = 'brush', color = '#ffffff', size = 5;
  let startX, startY;
  let snapshot; 
  let currentSticker = "‚≠ê"; // Default sticker

  // FLOOD FILL
  function floodFill(startX, startY, newColorHex) {
      const bigint = parseInt(newColorHex.slice(1), 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      const pixelStack = [[startX, startY]];
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const startPos = (startY * canvas.width + startX) * 4;
      const startR = data[startPos], startG = data[startPos+1], startB = data[startPos+2];
      if(startR === r && startG === g && startB === b) return;
      while(pixelStack.length) {
        const newPos = pixelStack.pop();
        const x = newPos[0], y = newPos[1];
        let pixelPos = (y * canvas.width + x) * 4;
        while(y-- >= 0 && matchColor(pixelPos, startR, startG, startB)) pixelPos -= canvas.width * 4;
        pixelPos += canvas.width * 4; y++;
        let reachLeft = false, reachRight = false;
        while(y++ < canvas.height - 1 && matchColor(pixelPos, startR, startG, startB)) {
            colorPixel(pixelPos, r, g, b);
            if(x > 0) { if(matchColor(pixelPos - 4, startR, startG, startB)) { if(!reachLeft) { pixelStack.push([x - 1, y]); reachLeft = true; } } else if(reachLeft) reachLeft = false; }
            if(x < canvas.width - 1) { if(matchColor(pixelPos + 4, startR, startG, startB)) { if(!reachRight) { pixelStack.push([x + 1, y]); reachRight = true; } } else if(reachRight) reachRight = false; }
            pixelPos += canvas.width * 4;
        }
      }
      ctx.putImageData(imageData, 0, 0);
      function matchColor(pos, r, g, b) { return (data[pos] === r && data[pos+1] === g && data[pos+2] === b); }
      function colorPixel(pos, r, g, b) { data[pos] = r; data[pos+1] = g; data[pos+2] = b; data[pos+3] = 255; }
  }

  // --- MOUSE HANDLERS ---
  const getPos = (e) => { const r = canvas.getBoundingClientRect(); if(e.touches) return {x: e.touches[0].clientX-r.left, y: e.touches[0].clientY-r.top}; return {x: e.offsetX, y: e.offsetY}; };

  const start = (e) => { 
      isDrawing=true; 
      ctx.beginPath(); 
      const p=getPos(e); 
      startX = p.x; startY = p.y;
      
      if(mode === 'fill') {
          floodFill(Math.floor(startX), Math.floor(startY), color);
          saveHistory();
          isDrawing = false;
          return;
      }
      if(mode === 'text') {
          const text = prompt("Enter Text:");
          if(text) { ctx.font = `${size*2}px Arial`; ctx.fillStyle = color; ctx.fillText(text, startX, startY); saveHistory(); }
          isDrawing = false;
          return;
      }
      if(mode === 'sticker') {
          // JUST STAMP IT (No Popup)
          ctx.font = `${size*3}px Arial`;
          ctx.fillText(currentSticker, startX, startY);
          saveHistory();
          isDrawing = false;
          return;
      }
      
      if(mode === 'rect' || mode === 'circle') snapshot = ctx.getImageData(0,0, canvas.width, canvas.height);
      else ctx.moveTo(p.x,p.y);
      if(e.type=='touchstart')e.preventDefault(); 
  };

  const move = (e) => { 
      // PREVIEW STICKER (Follows Mouse)
      if(mode === 'sticker' && !isDrawing) {
         // This is complex on 2D canvas without layers, skipping preview to keep it fast on low-end
         // Instead, we just rely on click-to-stamp
         return; 
      }

      if(!isDrawing) return; 
      if(e.type=='touchmove') e.preventDefault(); 
      const p=getPos(e); 
      
      if(mode === 'brush' || mode === 'eraser') {
          ctx.lineWidth = size; 
          ctx.lineCap = 'round'; 
          ctx.globalCompositeOperation = mode==='eraser'?'destination-out':'source-over'; 
          ctx.strokeStyle = mode==='eraser'?'rgba(0,0,0,1)':color; 
          ctx.lineTo(p.x,p.y); 
          ctx.stroke(); 
          ctx.beginPath(); 
          ctx.moveTo(p.x,p.y);
      } else if (mode === 'rect') {
          ctx.putImageData(snapshot, 0, 0); ctx.strokeStyle = color; ctx.lineWidth = size;
          ctx.strokeRect(startX, startY, p.x - startX, p.y - startY);
      } else if (mode === 'circle') {
          ctx.putImageData(snapshot, 0, 0); ctx.strokeStyle = color; ctx.lineWidth = size;
          ctx.beginPath();
          let r = Math.sqrt(Math.pow(p.x-startX,2) + Math.pow(p.y-startY,2));
          ctx.arc(startX, startY, r, 0, 2 * Math.PI);
          ctx.stroke();
      }
  };
  
  const end = () => { 
      if(isDrawing) saveHistory();
      isDrawing=false; 
      ctx.beginPath(); 
      ctx.globalCompositeOperation = 'source-over';
  };

  canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end);
  canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move); canvas.addEventListener('touchend', end);

  // --- BUTTON LOGIC ---
  const btns = document.querySelectorAll('.icon-btn');
  function setActive(id) {
      btns.forEach(b => b.classList.remove('active'));
      if(id && id !== 'undoBtn' && id !== 'clearBtn' && id !== 'bgBtn') {
        document.getElementById(id).classList.add('active');
        mode = id.replace('Btn','');

        // SPECIAL CASE: STICKER BUTTON CLICK
        if(mode === 'sticker') {
            const input = prompt("Choose an emoji to stamp:", currentSticker);
            if(input) currentSticker = input;
        }
      }
  }

  // TOOL BUTTONS
  document.getElementById('brushBtn').onclick = () => setActive('brushBtn');
  document.getElementById('eraserBtn').onclick = () => setActive('eraserBtn');
  document.getElementById('fillBtn').onclick = () => setActive('fillBtn');
  document.getElementById('rectBtn').onclick = () => setActive('rectBtn');
  document.getElementById('circleBtn').onclick = () => setActive('circleBtn');
  document.getElementById('textBtn').onclick = () => setActive('textBtn');
  document.getElementById('stickerBtn').onclick = () => setActive('stickerBtn');
  document.getElementById('undoBtn').onclick = undo;

  // BACKGROUNDS (FIXED)
  document.getElementById('bgBtn').onclick = () => {
      const type = prompt("Choose BG:\n1. White\n2. Black\n3. Graph Paper\n4. Blue Line (Notebook)");
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(type === '1') { ctx.fillStyle = 'white'; ctx.fillRect(0,0,canvas.width,canvas.height); }
      else if(type === '2') { ctx.fillStyle = 'black'; ctx.fillRect(0,0,canvas.width,canvas.height); }
      else if(type === '3') { 
          // Graph
          ctx.fillStyle = 'white'; ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.strokeStyle = '#ddd'; ctx.lineWidth = 1;
          for(let i=0; i<canvas.width; i+=20) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
          for(let i=0; i<canvas.height; i+=20) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }
      }
      else if(type === '4') { 
          // Blue Line (Notebook)
          ctx.fillStyle = 'white'; ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.strokeStyle = '#a4c2f4'; ctx.lineWidth = 1; // Light Blue
          
          // Draw Vertical Margin Line
          ctx.beginPath(); ctx.moveTo(40, 0); ctx.lineTo(40, canvas.height); 
          ctx.strokeStyle = '#ffcccc'; // Red Margin
          ctx.stroke();

          // Draw Horizontal Blue Lines
          ctx.strokeStyle = '#a4c2f4';
          for(let i=40; i<canvas.height; i+=30) { 
              ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); 
          }
      }
      saveHistory();
  };

  document.getElementById('colorPicker').oninput = (e) => color=e.target.value;
  document.getElementById('sizeSlider').oninput = (e) => { size=e.target.value; document.getElementById('sizeLabel').innerText = size+"px"; };
  document.getElementById('clearBtn').onclick = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height); saveHistory(); };

  document.getElementById('submitBtn').onclick = async () => { 
      const btn = document.getElementById('submitBtn'); 
      try { 
          btn.textContent = "Saving..."; btn.disabled = true; 
          const id = localStorage.getItem("current_student_id");
          const img = canvas.toDataURL("image/png");
          await updateDoc(doc(db, "students", id), { drawingBase64: img, status: "Submitted" });
          alert("Saved!");
          window.location.href="index.html";
      } catch(e) { console.error(e); btn.textContent = "Save"; btn.disabled = false; } 
  };
</script>
</body>
</html>