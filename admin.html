<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="dark">
    <div class="form-wrapper" style="align-items: flex-start; padding-top: 50px;">
        <div class="form-card admin-card">
            <div class="header" style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Live Student Data</h2>
                <button onclick="location.href='index.html'" style="width:auto; padding:8px 15px; font-size:12px;">üè† Home</button>
            </div>
            
            <table class="admin-table">
                <thead>
                    <tr>
                        <th style="width: 25%">Student</th>
                        <th style="width: 30%">Contact</th>
                        <th style="width: 15%; text-align:center;">Security</th>
                        <th style="width: 15%">Work</th>
                        <th style="width: 15%">Status</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="5" style="text-align:center; padding: 20px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="infoModal">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('infoModal').style.display='none'">√ó</span>
            <h2 id="modalTitle" style="margin-bottom:20px; color:#fff;">Details</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <script type="module">
        import { db, collection, onSnapshot } from "./config.js";

        // FUNCTION 1: VIEW STUDENT WORK
        window.viewWork = (type, content) => {
            const modal = document.getElementById("infoModal");
            const body = document.getElementById("modalBody");
            document.getElementById("modalTitle").innerText = type === 'story' ? "üìù Student Story" : "üé® Student Art";
            
            if(type === 'story') {
                body.innerHTML = `<p style="font-size:18px; line-height:1.6; color:#ccc; white-space: pre-wrap;">${content}</p>`;
            } else {
                body.innerHTML = `<img src="${content}" style="width:100%; border-radius:10px; border:1px solid #444;">`;
            }
            modal.style.display = "flex";
        };

        // FUNCTION 2: VIEW SECURITY DETAILS
        window.viewSecurity = (lat, lng, ip, device) => {
            const modal = document.getElementById("infoModal");
            const body = document.getElementById("modalBody");
            document.getElementById("modalTitle").innerText = "üîí Security Profile";
            
            const mapLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
            
            body.innerHTML = `
                <div style="text-align:center; margin-bottom:20px;">
                    <a href="${mapLink}" target="_blank" class="primary-btn" style="text-decoration:none; display:inline-block; margin-bottom:15px; background:#00e5ff; color:#000;">
                        üó∫Ô∏è Open Google Maps
                    </a>
                    <p style="color:#aaa; font-size:12px;">Coordinates: ${lat}, ${lng}</p>
                </div>
                <hr style="border-color:#333; margin:20px 0;">
                <div style="color:#fff; text-align:left; font-size:14px; line-height:2;">
                    <p><strong>üåê IP Address:</strong> <br><span style="color:#00e5ff">${ip}</span></p>
                    <p><strong>üì± Device Info:</strong> <br><span style="color:#ff00e5; font-family:monospace; font-size:12px;">${device}</span></p>
                </div>
            `;
            modal.style.display = "flex";
        };

        onSnapshot(collection(db, "students"), (snapshot) => {
            const tbody = document.getElementById("tableBody");
            if (snapshot.empty) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No data.</td></tr>`; return; }
            tbody.innerHTML = "";
            
            snapshot.forEach(doc => {
                const d = doc.data();
                
                // 1. PIN ICON BUTTON
                let pinBtn = `<span style="font-size:20px; opacity:0.3; cursor:not-allowed;">üö´</span>`;
                if(d.location && d.location.lat) {
                    // We pass data to the modal function on click
                    pinBtn = `<button onclick='viewSecurity(${d.location.lat}, ${d.location.lng}, "${d.ipAddress || "Unknown"}", "${d.deviceInfo || "Unknown"}")' style="background:none; border:none; font-size:24px; cursor:pointer;" title="View Security Details">üìç</button>`;
                }

                // 2. WORK BUTTON
                let workBtn = `<span style="opacity:0.3">-</span>`;
                if(d.story) {
                    const safeStory = d.story.replace(/"/g, '"').replace(/'/g, "'");
                    workBtn = `<button onclick='viewWork("story", "${safeStory}")' style="font-size:12px; padding:6px 12px; background:#00e5ff; color:#000; border-radius:6px; font-weight:bold;">View Story</button>`;
                } else if (d.drawingBase64) {
                    workBtn = `<button onclick='viewWork("art", "${d.drawingBase64}")' style="font-size:12px; padding:6px 12px; background:#ff00e5; color:#fff; border-radius:6px; font-weight:bold;">View Art</button>`;
                }

                const row = `
                    <tr>
                        <td><b>${d.studentName}</b><br><small>${d.grade} (${d.section})</small></td>
                        <td>${d.parentName}<br><small>${d.contact}</small></td>
                        <td style="text-align:center;">${pinBtn}</td>
                        <td>${workBtn}</td>
                        <td><span style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; font-size: 11px;">${(d.story || d.drawingBase64) ? "‚úÖ DONE" : "‚è≥"}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        });
    </script>
</body>
</html>