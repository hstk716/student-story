<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* SCROLLABLE TABLE CSS */
        .table-container {
            max-height: 65vh; /* Sets fixed height */
            overflow-y: auto; /* Adds scrollbar if list is long */
            border-radius: 12px;
            border: 1px solid rgba(125,125,125,0.2);
        }
        .admin-table th {
            position: sticky; top: 0;
            background: #1a1a1a; /* Keep header visible while scrolling */
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        /* FILTER INPUT STYLE */
        #searchBox {
            padding: 8px 15px; border-radius: 8px; border: 1px solid #444;
            background: rgba(255,255,255,0.1); color: white; font-size: 13px; width: 200px;
        }
    </style>
</head>
<body class="dark">
    <div class="form-wrapper" style="align-items: flex-start; padding-top: 30px;">
        <div class="form-card admin-card">
            
            <div class="header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; margin-bottom: 20px;">
                <div>
                    <h2 style="margin:0; text-align:left;">Student Data</h2>
                    <span id="activeCount" style="color:#00ffaa; font-size:12px;">Connecting...</span>
                </div>
                
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="searchBox" placeholder="üîç Filter (e.g. 5A, Rahul)..." onkeyup="filterTable()">
                    
                    <button onclick="downloadCSV()" class="gold-btn" style="padding:8px 15px; font-size:12px; white-space:nowrap;">üìä Export Visible</button>
                    <button onclick="location.href='index.html'" style="padding:8px 15px; font-size:12px;">üè† Home</button>
                </div>
            </div>
            
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Network/IP</th>
                            <th style="text-align:center;">Loc</th>
                            <th style="text-align:center;">Work</th>
                            <th style="text-align:center;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="5" style="text-align:center; padding: 20px;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="infoModal">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('infoModal').style.display='none'">√ó</span>
            <h2 id="modalTitle" style="margin-bottom:20px; color:#fff;">Details</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <script type="module">
        import { db, collection, onSnapshot, doc, deleteDoc } from "./config.js";

        window.allStudents = {}; // Stores raw data
        window.filteredIDs = []; // Stores currently visible IDs

        // --- 1. SEARCH / FILTER FUNCTION ---
        window.filterTable = () => {
            const query = document.getElementById("searchBox").value.toLowerCase();
            const rows = document.querySelectorAll(".student-row");
            let visibleCount = 0;
            window.filteredIDs = [];

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                const id = row.getAttribute("data-id");
                
                // If row text matches search (e.g. "5A" matches "Grade: 5 (A)")
                if(text.includes(query)) {
                    row.style.display = "";
                    visibleCount++;
                    window.filteredIDs.push(id);
                } else {
                    row.style.display = "none";
                }
            });
            document.getElementById("activeCount").innerText = `üü¢ Showing: ${visibleCount}`;
        };

        // --- 2. SMART CSV EXPORT (Exports only what you filtered) ---
        window.downloadCSV = () => {
            // Use filteredIDs if filter is active, otherwise all IDs
            const idsToExport = window.filteredIDs.length > 0 ? window.filteredIDs : Object.keys(window.allStudents);
            
            if(idsToExport.length === 0) return alert("No data to export!");

            const rows = [["Name", "Grade", "Section", "Parent", "Phone", "IP Address", "Network", "Battery", "Work Type"]];
            
            idsToExport.forEach(id => {
                const d = window.allStudents[id];
                if(!d) return;

                let workType = d.story ? "Story" : (d.drawingBase64 ? "Art" : "Pending");
                let cleanName = `"${d.studentName}"`;
                
                rows.push([
                    cleanName, d.grade, d.section, d.parentName, d.contact, 
                    d.ipAddress, d.connection || "N/A", d.battery || "N/A", workType
                ]);
            });

            let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = "student_data_filtered.csv";
            document.body.appendChild(link);
            link.click();
        };

        // --- 3. VIEW FUNCTIONS ---
        window.viewWork = (id, type) => {
            const data = window.allStudents[id];
            const modal = document.getElementById("infoModal");
            const body = document.getElementById("modalBody");
            document.getElementById("modalTitle").innerText = type === 'story' ? "üìù Story" : "üé® Art";
            
            if(type === 'story') {
                body.innerHTML = "";
                const p = document.createElement("div");
                p.style.cssText = "font-size:16px; line-height:1.6; color:#ccc; white-space: pre-wrap; max-height:60vh; overflow-y:auto; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px;";
                p.innerText = data.story || "No text.";
                body.appendChild(p);
            } else {
                body.innerHTML = `<img src="${data.drawingBase64}" style="width:100%; border-radius:10px;">`;
            }
            modal.style.display = "flex";
        };

        window.viewSecurity = (id) => {
            const d = window.allStudents[id];
            const modal = document.getElementById("infoModal");
            const body = document.getElementById("modalBody");
            document.getElementById("modalTitle").innerText = "üîí Security Profile";
            
            // Check for Suspicious Flag (20)
            const warning = d.isSuspicious ? "<h3 style='color:red; text-align:center;'>‚ö†Ô∏è SUSPICIOUS: VPN/Proxy Detected</h3>" : "";

            const mapLink = d.location && d.location.lat ? 
                `https://www.google.com/maps?q=${d.location.lat},${d.location.lng}` : "#";

            body.innerHTML = `
                ${warning}
                <div style="text-align:center;">
                    <a href="${mapLink}" target="_blank" class="primary-btn" style="text-decoration:none; display:inline-block; margin-bottom:15px; background:#00e5ff; color:#000;">üó∫Ô∏è Open Google Maps</a>
                </div>
                <hr style="border-color:#333; margin:20px 0;">
                <p><strong>üåê IP:</strong> <span style="color:#00e5ff">${d.ipAddress}</span></p>
                <p><strong>üñ•Ô∏è Screen:</strong> <span style="color:#ffaa00">${d.screenRes || "Unknown"}</span></p> <p><strong>üì∂ Network:</strong> <span style="color:#ffaa00">${d.connection || "Unknown"}</span></p>
                <p><strong>üîã Battery:</strong> <span style="color:#00ffaa">${d.battery || "Unknown"}</span></p>
                <p><strong>üì± Device:</strong> <span style="color:#aaa; font-size:12px;">${d.deviceInfo}</span></p>
            `;
            modal.style.display = "flex";
        };

        window.deleteStudent = async (id) => {
            if(confirm("‚ö†Ô∏è Delete this student permanently?")) {
                const p = prompt("Admin Password:");
                if(btoa(p) === "OTAyMTA=") {
                    try { await deleteDoc(doc(db, "students", id)); } 
                    catch(e) { alert("Error: " + e.message); }
                } else { alert("Wrong Password"); }
            }
        };

        // --- 4. DATA LISTENER ---
        onSnapshot(collection(db, "students"), (snapshot) => {
            const tbody = document.getElementById("tableBody");
            document.getElementById("activeCount").innerText = `üü¢ Total: ${snapshot.size}`;
            
            if (snapshot.empty) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No data yet.</td></tr>`; return; }
            
            tbody.innerHTML = "";
            window.allStudents = {}; 
            window.filteredIDs = [];

            snapshot.forEach(docSnap => {
                // TRY-CATCH PREVENTS CRASHES IF ONE DATA POINT IS BAD
                try {
                    const d = docSnap.data();
                    const id = docSnap.id;
                    window.allStudents[id] = d;
                    window.filteredIDs.push(id);

                    // Handle "Missing 4G" issue cleanly
                    const netInfo = d.connection ? d.connection : `<span style="opacity:0.3">N/A</span>`;

                    let pinBtn = `<span style="opacity:0.3">üö´</span>`;
                    if(d.location && d.location.lat) {
                        pinBtn = `<button onclick='viewSecurity("${id}")' style="background:none; border:none; font-size:20px; cursor:pointer;">üìç</button>`;
                    }

                    let workBtn = `<span style="opacity:0.3; font-size:12px;">Pending</span>`;
                    if(d.story) workBtn = `<button onclick='viewWork("${id}", "story")' style="font-size:11px; padding:4px 8px; background:#00e5ff; color:#000; border-radius:4px; font-weight:bold;">Story</button>`;
                    else if (d.drawingBase64) workBtn = `<button onclick='viewWork("${id}", "art")' style="font-size:11px; padding:4px 8px; background:#ff00e5; color:#fff; border-radius:4px; font-weight:bold;">Art</button>`;

                    const row = `
                        <tr class="student-row" data-id="${id}">
                            <td><b>${d.studentName}</b><br><small style="color:#aaa">${d.grade} (${d.section})</small></td>
                            <td style="font-size:11px; color:#ccc;">${d.ipAddress.split('(')[0]}<br><span style="color:#ffaa00">${netInfo}</span></td>
                            <td style="text-align:center;">${pinBtn}</td>
                            <td style="text-align:center;">${workBtn}</td>
                            <td style="text-align:center;">
                                <button onclick="deleteStudent('${id}')" style="background:rgba(255,0,0,0.2); border:1px solid red; color:red; padding:5px 8px; border-radius:6px; cursor:pointer;">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                } catch(e) { console.error("Error loading row", e); }
            });
            
            // Re-run filter if search box has text
            filterTable();
        });
    </script>
</body>
</html>